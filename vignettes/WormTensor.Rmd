---
title: "Clustering and visualization of time-series whole-brain activity data of C. elegans using `WormTensor`"
author:
- name: Kentaro Yamamoto
  affiliation: Laboratory for Bioinformatics Research,
    RIKEN Center for Biosystems Dynamics Research
- name: Koki Tsuyuzaki
  affiliation: Laboratory for Bioinformatics Research,
    RIKEN Center for Biosystems Dynamics Research
- name: Itoshi Nikaido
  affiliation: Laboratory for Bioinformatics Research,
    RIKEN Center for Biosystems Dynamics Research
  email: yamaken37.the.answer@gmail.com
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{WormTensor}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
options(rmarkdown.html_vignette.check_title = FALSE)
```

# Load libraries
Install WormTensor package from CRAN or GitHub in advance and then type the code below in the R console window.
```{r Load libraries, echo=TRUE}
library(WormTensor)
```

# worm_download
The worm_download is a function to retrieve data from figshare for a total of 28 animals (24 normal and 4 noisy).
If there is no argument,  mSBD distance matrices (including 24 normal animals) will be downloaded.
```{r worm_download, echo=TRUE}
object <- worm_download()
```

# as_worm_tensor
```{r as_worm_tensor, echo=TRUE}
object <- as_worm_tensor(object$Ds)
```

# worm_membership
```{r worm_membership, echo=TRUE}
object <- worm_membership(object, k=6)
```

# worm_clustering
```{r worm_clustering, echo=TRUE}
object <- worm_clustering(object)
```

# worm_evaluate
```{r worm_evaluate, echo=TRUE}
object <- worm_evaluate(object)
```

# worm_visualize
```{r worm_visualize, echo=TRUE}
object <- worm_visualize(object)
```

# Pipe Operation
```{r pipe_operation, echo=TRUE}
worm_download()$Ds |>
    as_worm_tensor() |>
        worm_membership(k=6) |>
            worm_clustering() |>
                worm_evaluate() |>
                    worm_visualize() -> object
```

# worm_distance
```{r worm_distance, echo=TRUE}
# Toy data
n_cell_x <- 13
n_cell_y <- 24
n_cell_z <- 29
n_cells <- 30
n_time_frames <- 100

# 13 cells, 100 time frames
animal_x <- matrix(runif(n_cell_x*n_time_frames),
    nrow=n_cell_x, ncol=n_time_frames)
rownames(animal_x) <- sample(seq(n_cells), n_cell_x)
colnames(animal_x) <- seq(n_time_frames)

# 24 cells, 100 time frames
animal_y <- matrix(runif(n_cell_y*n_time_frames),
    nrow=n_cell_y, ncol=n_time_frames)
rownames(animal_y) <- sample(seq(n_cells), n_cell_y)
colnames(animal_y) <- seq(n_time_frames)

# 29 cells, 100 time frames
animal_z <- matrix(runif(n_cell_z*n_time_frames),
    nrow=n_cell_z, ncol=n_time_frames)
rownames(animal_z) <- sample(seq(n_cells), n_cell_z)
colnames(animal_z) <- seq(n_time_frames)

# Positive Control of Difference between SBD and mSBD
animal_z[2, ] <- - animal_x[1, ]

# Input list for worm_distnce
X <- list(animal_x=animal_x,
    animal_y=animal_y,
    animal_z=animal_z)

worm_distance(X, "mSBD") |>
    as_worm_tensor() |>
        worm_membership(k=6) |>
            worm_clustering() |>
                worm_evaluate() |>
                    worm_visualize(tsne.perplexity=5) -> object
```
